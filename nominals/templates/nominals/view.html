{% extends 'accountancy/view.html' %}

{% load static %}
{% load crispy_forms_tags %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'purchases/css/purchase_input.css' %}">
{% endblock extra_head %}

{% block module_actions %}
<div class="ml-3">
    <div class="dropdown">
        <button class="btn btn-sm bg-primary text-white dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Options
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <a class="dropdown-item small" href="{% url 'nominals:edit' pk=view %}">Edit</a>
            {% crispy void_form %}
        </div>
    </div>
</div>
{% endblock module_actions %}

{% block modal_forms %}
    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title font-weight-bold" id="exampleModalLabel">Confirm</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body small">
                Are you sure you want to void this transaction?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-sm btn-danger void">Void</button>
            </div>
            </div>
        </div>
    </div>
{% endblock modal_forms %}

{{ void_form }}

{% block module_js %}
<script>
    {% include 'accountancy/calculator.js' %}
</script>
<script>

    function show_error(errors){
        if(errors){

        }
        else{
            // show generic error like ... something went wrong please try again
            alert("Something went wrong.  Please try again later.");
        }
    }


    $(document).ready(function() {
        $("form.void-form").on("click", function(event) {
            $(".modal").modal("show");
        });
        $("button.void").on("click", function() {
            var form = $("form.void-form");
            $.ajax({
                url: form.attr("action"),
                method: "POST",
                data: form.serialize(),
                success: function (data) {
                    if(data.success) {
                        // set cookie or something to say void was successful
                        // server then adds a message which is shown at data.href URL
                        return window.location.href = data.href;
                    }
                    else{
                        show_error();
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log("There was an error creating the new item", jqXHR, textStatus, errorThrown);
                    show_eror();
                }
            });
        });
    });
</script>
{% endblock module_js %}