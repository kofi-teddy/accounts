{% load static %}
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="{% static 'js/infinite_scroll.js' %}"></script>
<script src="{% static 'js/input_dropdown_widget.js' %}"></script>
<script src="{% static 'js/grid.js' %}"></script>
<script src="{% static 'js/error_tooltip.js' %}"></script>
<script>
    {% include "accountancy/input_grid.js" %}
    {% comment %} this requires server side input so is a template {% endcomment %}
</script>
<script>
    {% include "accountancy/calculator.js" %}
    {% comment %} again needs server side injection so we know whether we have debit or credit transaction type {% endcomment %}
</script>
<script src="{% static 'js/selectize.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
<script src="{% static 'js/modal_form.js' %}"></script>
{{ header_form.media }}
<script>

    $(document).ready(function(){
        $(".datepicker").removeClass("form-control");
    });

    {% if create or edit %}

    $(".transaction-type-select").selectize();

    {% endif %}

    {% if create %}

        $("select.transaction-type-select").on("change", function() {
            var transaction_type = $(this).val();
            var url = window.location.href.split('?')[0];
            window.location.href = url + "?t=" + transaction_type;
        });

    {% endif %}

    {% comment %} 
    
    the standard example of loading from a remote source for the selectize.js library uses
    jsonp which was new to me.  JSONP was only created for loading from another domain so is not needed here.
    It was also created back in 2005 so not sure it is needed at all anymore.

    Here we just use json.  Callback is obviously a function passed in from the library itself.
    
    {% endcomment %}

    {% if create or edit %}

        var native_select_widget = $(".contact-select");
        var creation_url = native_select_widget.attr("data-creation-url");
        var form = native_select_widget.attr("data-form");
        var form_field = native_select_widget.attr("data-form-field");
        var load_url = native_select_widget.attr("data-load-url");

        $(".contact-select").selectize({
            valueField: 'id',
            labelField: 'code',
            searchField: 'code',
            insert: true,
            create: function(input, callback) {
                $.ajax({
                    url: creation_url,
                    method: "POST",
                    // here we hard code the form prefix 'supplier'
                    data: "form=" + form + "&" + form_field + "=" + input + "&csrfmiddlewaretoken=" + Cookies.get('csrftoken'),
                    success: function (data) {
                        if(data.success) {
                            callback({
                                id: data.result.id,
                                code: data.result.text
                            });
                            // spent ages on this
                            // selectize.js says the keys should be value and text but according to below this is wrong
                            // https://github.com/selectize/selectize.js/issues/1329#issuecomment-358857146
                            // https://stackoverflow.com/questions/24366365/creating-an-item-if-not-already-exists-in-selectize-js-select-box-and-ajax-updat
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log("There was an error creating the new item", jqXHR, textStatus, errorThrown);
                        callback({
                            id: '',
                            code: ''
                        });
                    }
                });
            },
            load: function(query, callback) {
                $.ajax({
                    url: load_url,
                    type: 'GET',
                    dataType: 'json',
                    data: {
                        q: query,
                        page_limit: 10,
                    },
                    error: function() {
                        console.log("error loading suppliers...");
                    },
                    success: function(res) {
                        callback(res.data);
                    }
                });
            }
        });


        $(".cashbook-select").selectize();

    {% endif %}

</script>