{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'accountancy/css/style.css' %}">
    {% block head %}
    {% endblock head %}
  </head>
  <body>

    <header class="header-nav bg-primary-blue font-weight-bold">
      <nav class="navbar navbar-expand-lg text-white">
        <div class="collapse navbar-collapse justify-content-between" id="navbarNavDropdown">
          <ul class="navbar-nav">
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Demo Company (UK)
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <div class="p-3 small font-weight-bold">Demo Company (UK)</div>
                    <a class="dropdown-item" href="{% url 'controls:index' %}">Settings</a>
                </div>
            </div>
            <li class="nav-item active">
              <a class="nav-link" href="{% url 'dashboard:dashboard' %}">Dashboard</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link" href="#" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Purchases
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                <a class="dropdown-item" href="{% url 'purchases:transaction_enquiry' %}">View Transactions</a>
                <a class="dropdown-item" href="{% url 'purchases:create' %}">Post Transaction</a>
                <a class="dropdown-item" href="{% url 'purchases:creditors_report' %}">Age Creditors Report</a>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link" href="#" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Sales
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                <a class="dropdown-item" href="{% url 'sales:transaction_enquiry' %}">View Transactions</a>
                <a class="dropdown-item" href="{% url 'sales:create' %}">Post Transaction</a>
                <a class="dropdown-item" href="{% url 'sales:debtors_report' %}">Age Debtors Report</a>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Nominal
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                <a class="dropdown-item" href="{% url 'nominals:transaction_enquiry' %}">View Transactions</a>
                <a class="dropdown-item" href="{% url 'nominals:create' %}">Post Transaction</a>
                <a class="dropdown-item" href="{% url 'nominals:trial_balance' %}">Trial Balance</a>
                <a class="dropdown-item" href="{% url 'nominals:nominals_list' %}">Nominals</a>
                <div class="dropdown dropright">
                    <a class="dropdown-item dropdown-toggle pointer" id="dropdown-layouts" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Financial Year Ends</a>
                    <div class="dropdown-menu" aria-labelledby="dropdown-layouts">
                        <a class="dropdown-item text-capitalize" href="{% url 'nominals:finalise_fy' %}">finalise</a>
                        <a class="dropdown-item text-capitalize" href="{% url 'nominals:rollback_fy' %}">rollback</a>
                    </div>
                </div>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link" href="#" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Cash Book
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                <a class="dropdown-item" href="{% url 'cashbook:transaction_enquiry' %}">View Transactions</a>
                <a class="dropdown-item" href="{% url 'cashbook:create' %}">Post Transaction</a>
                <a class="dropdown-item" href="{% url 'cashbook:cashbook_list' %}">Cashbooks</a>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link" href="#" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Vat
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                <a class="dropdown-item" href="{% url 'vat:transaction_enquiry' %}">View Transactions</a>
                <a class="dropdown-item" href="{% url 'vat:vat_list' %}">Vat Codes</a>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link" href="#" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Contacts
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                <a class="dropdown-item" href="{% url 'contacts:list' %}?q=all">All</a>
                <a class="dropdown-item" href="{% url 'contacts:list' %}?q=customers">Customers</a>
                <a class="dropdown-item" href="{% url 'contacts:list' %}?q=suppliers">Suppliers</a>
              </div>
            </li>
          </ul>
          <ul class="nav-bar nav">
            <li class="dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                {{ request.user.username }}
              </a>
              <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                <a class="dropdown-item" href="{% url 'users:profile' %}">Profile</a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="{% url 'logout' %}">Log Out</a>
              </div>
            </li>
          </ul>
        </div>
      </nav>
    </header>

    {% block content %}
    {% endblock content %}

    {% block modal_forms %}
    {% endblock modal_forms %}

    {% if locked_by_another %}
        {% include 'accountancy/edited_by_another.html' %}
    {% endif %}

    {% if unlock_url %}
        {% include 'accountancy/unlock_form.html' with action=unlock_url %}
    {% endif %}

    {% include 'messages.html' with messages=messages %}
    {% include 'messages_clientside.html' %}
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
    <script src="{% static 'js/bootstrap_multi_level_dropdown.js' %}"></script>
    {% block js %}
        {% block extra_js %}
        {% endblock extra_js %}
        {% block module_js %}
        {% endblock module_js %}
    {% endblock js %}
    <script src="{% static 'accountancy/js/content_loaded.js' %}"></script>
    <script src="{% static 'accountancy/js/reload.js' %}"></script>
    <script>
        $(document).ready(function(){

            var locked_by_another = '{{ locked_by_another }}';
            if(locked_by_another){
                $("#edited_by_another_modal").modal("show");
                $("#edited_by_another_modal").on("hide.bs.modal", function(e){
                    e.preventDefault();
                    e.stopPropagation();
                });
            }

            var unlocked = false;
            var before_unload_began;

            function unlock() {
                var unlock_form = $("form.unlock_form");
                if(unlock_form.length){
                    $.ajax({
                        type: "POST",
                        url: unlock_form.attr("action"),
                        data: unlock_form.serialize(),
                        success: function (data) {
                            unlocked = true; // we assume
                        }
                    })
                }
            }

            window.addEventListener('beforeunload', function(event){
                before_unload_began = Date.now();
                unlock();
                while(!unlocked){
                    if(Date.now() - before_unload_began > 100){
                        return; // never wait longer than 100 ms
                    }
                }
            });

        });
    </script>
  </body>
</html>